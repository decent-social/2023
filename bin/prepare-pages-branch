#!/bin/bash
set -e

OUT_DIR="${OUT_DIR:-out}"
OUT_DIR_SPLIT_BRANCH="${OUT_DIR_SPLIT_BRANCH:-$(date +%s)-out-dir}"
PAGES_PR_TARGET_REMOTE="${PAGES_PR_TARGET_REMOTE:-origin}"
PAGES_PR_TARGET_BRANCH="${PAGES_PR_TARGET_BRANCH:-pages}"
PAGES_PR_SRC_BRANCH="${PAGES_PR_SRC_BRANCH:-$(date +%s)-pages}"
START_BRANCH="$(git rev-parse --abbrev-ref HEAD)"
CODEBERG_REPO_URL="${CODEBERG_REPO_URL:-https://codeberg.org/DecentSocial/website}"

help() {
cat << EOF
This script creates a branch from just the '$OUT_DIR' directory, and switches to it with changes (on top of $PAGES_PR_TARGET_BRANCH) staged so you can make a commit.
This is useful for then pushing the branch to a remote repository, e.g. for pages.codeberg.org to serve.
EOF
}

main() {
  if ! [ -d "$OUT_DIR" ]; then
      1>&2 echo "Error: Cannot find output directory '$OUT_DIR'"
      exit 1
  fi

  # commit $OUT_DIR - required for subtree
  1>&2 git add --force $OUT_DIR
  1>&2 git commit -m "committing $OUT_DIR before splitting subtree"
  echo "commit_return_code=$commit_return_code"

  # split out new branch from $OUT_DIR. This does not switch to the branch.
  1>&2 git subtree split --prefix=$OUT_DIR -b $OUT_DIR_SPLIT_BRANCH
  # Now undo the commit that added $OUT_DIR
  # commit_return_code will be 1 if no commit was actually added
  if [ $commit_return_code -ne 1 ]; then
    1>&2 git reset HEAD^
  fi

  1>&2 echo "Split $OUT_DIR to branch '$OUT_DIR_SPLIT_BRANCH'"

  # Create a new branch derrived from `pages` branch
  1>&2 git checkout $PAGES_PR_TARGET_BRANCH
  1>&2 git checkout -b $PAGES_PR_SRC_BRANCH --track $PAGES_PR_TARGET_REMOTE/$PAGES_PR_TARGET_BRANCH
  # rm old contents from previous builds
  1>&2 rm -rf * .next
  # write all contents from the branch we created from the $OUT_DIR subtree
  1>&2 git checkout $OUT_DIR_SPLIT_BRANCH -- .
  # makes `git push` work nicely
  1>&2 git config push.default current

  echo "$PAGES_PR_SRC_BRANCH"
  1>&2 echo "PR into pages branch at $CODEBERG_REPO_URL/compare/pages...$PAGES_PR_SRC_BRANCH"
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    help
    exit
fi

main
